# NetShell Raffy
RFID-enabled authentication, authorization and time tracking for company propery access control.

## Requirements

### Redis Server
`sudo apt install redis-server -y`

### nginx
`sudo apt install nginx -y`

### PHP 7
`sudo apt install php7.2 php7.2-fpm -y`

### PHP-Redis Extension
`sudo apt install php7.2-redis -y`

### Laravel Echo
`npm install -g laravel-echo-server`

## Setup

### nginx
1. Create config file for Raffy.

/etc/nginx/sites-available/raffy:
```
server {
	# SSL configuration
	listen 443 ssl default_server;
	listen [::]:443 ssl default_server;

	# Self signed certs generated by the ssl-cert package
	# Don't use them in a production server!
	include snippets/self-signed.conf;
	include snippets/ssl-params.conf;

	root /path/to/raffy/public;
	index index.php;
	server_name _;

	location / {
		try_files $uri $uri/ /index.php?$query_string;
	}

	# Pass PHP scripts to FastCGI server
	location ~ \.php$ {
		include snippets/fastcgi-php.conf;
	
		# With php-fpm (or other unix sockets):
		fastcgi_pass unix:/var/run/php/php7.2-fpm.sock;
	}

	location ~ /\.ht {
		deny all;
	}
}
```

2. Enable the site

`cd /etc/nginx/sites-enabled; sudo ln -s ../sites-available/raffy raffy;`

3. Reload nginx

`sudo service nginx reload`

### Hosts File
Edit `/etc/hosts` as root and add entry for `raffy-admin` to match your IP:
```
127.0.0.1     raffy-admin
```

### Raffy
1. Navigate to where you cloned Raffy Admin.

`cd /path/to/raffy`

2. Install dependencies.
```
composer install;
npm install;
```

3. Build assets
```
sudo npm install --global cross-env;
npm run prod;
```
*Alternatively, you could build assets for development (`npm run dev`) or watch for changes to source, which can be useful when actively modifying them (`npm run watch`). However, production assets are more secure, load faster and are very optimized.*

4. Assure filesystem permissions.

```
cd /path/to/raffy;
chgrp www-data -R ./;
chmod g+w -R ./;
```

## Configuration
1. Set environment variables.

`cp .env.example .env`

Then open `.env` and make sure all database and Redis credentials are correct. That includes `DB_HOST`, `DB_DATABASE`, `DB_USERNAME`, `DB_PASSWORD`, `REDIS_HOST` and `REDIS_PASSWORD`, as well as any other keys that are relevant.

2. Set Redis authentication for Laravel Echo. 

Edit `laravel-echo-server.json` and set the Redis password there as well.

3. Run migrations.

`php artisan migrate`

4. Import Voyager configuration.

`php artisan voyager:import -y`

## Running
1. Start the web socket server
`laravel-echo-server start`

2. **Test in browser!**

Go to

[http://raffy-admin](http://raffy-admin)

You should see the login screen or maybe a friendly error if something went wrong.
